# Commit-Reveal 방식 이해하기

## Commit-Reveal이란?

Commit-Reveal은 **암호학적 기법**으로, 참여자들이 서로의 선택을 보지 못한 상태에서 공정하게 게임을 진행할 수 있도록 보장합니다.

### 핵심 개념

```
문제:
게임에서 다른 사람의 선택을 보고
나중에 선택하면 유리해진다

해결:
1. Commit: 선택을 암호화하여 먼저 제출
2. Reveal: 모두 제출 후 동시에 공개
```

## 왜 필요한가요?

### 기존 방식의 문제점

#### 순차적 선택 방식

```
❌ 문제점:

참가자 A: 블록 7번 선택 → 공개
참가자 B: (A의 선택을 보고) 블록 3번 선택 → 공개
참가자 C: (A, B 선택을 보고) 블록 1번 선택 → 공개

결과: 나중에 선택한 사람이 압도적으로 유리
```

#### 동시 선택 방식 (암호화 없음)

```
❌ 문제점:

참가자들이 동시에 선택하지만
- 네트워크 속도 차이
- 서버 도착 시간 차이
→ 먼저 도착한 선택이 공개됨
→ 늦게 도착한 사람이 변경 시도 가능
```

### Commit-Reveal 방식의 해결

```
✅ 해결:

1단계 (Commit):
모든 참가자가 선택을 암호화하여 제출
→ 다른 사람이 볼 수 없음
→ 제출 후 변경 불가

2단계 (Reveal):
모든 참가자가 제출 완료 후
→ 동시에 모든 선택 공개
→ 누구도 유리하지 않음
```

## Commit-Reveal 작동 원리

### 1단계: Commit (약속 제출)

#### 사용자 측

```
1. 사용자가 블록 선택 (예: 7번)
   ↓
2. 무작위 값(nonce) 생성
   예: "a7f3k2m9"
   ↓
3. 해시 함수로 암호화
   Hash(7번 + a7f3k2m9) = "0x1a2b3c4d..."
   ↓
4. 암호화된 값을 블록체인에 제출
```

**암호화 예시**
```
선택: 7번
Nonce: a7f3k2m9
해시: SHA-256(7 + a7f3k2m9)
결과: 0x1a2b3c4d5e6f7g8h...

이 값만 제출 → 누구도 7번인지 알 수 없음
```

#### 블록체인 측

```
스마트 컨트랙트에 기록:

사용자 A: 0x1a2b3c4d... (Commit 완료)
사용자 B: 0x9z8y7x6w... (Commit 완료)
사용자 C: 0x5m4n3b2v... (Commit 완료)

⚠️ 이 시점에는 누구도 실제 선택을 알 수 없음
```

### 2단계: Reveal (공개)

#### 모든 참가자 제출 완료 후

```
카운트다운 시작 (5분)
   ↓
각 참가자가 원본 데이터 제출:
   - 선택한 블록 번호
   - Nonce 값
   ↓
스마트 컨트랙트가 검증:
   Hash(블록 번호 + Nonce) = Commit 값?
   ↓
일치하면 유효한 선택으로 인정
```

**검증 예시**
```
사용자 A가 Reveal 제출:
- 블록 번호: 7번
- Nonce: a7f3k2m9

스마트 컨트랙트 검증:
Hash(7 + a7f3k2m9) = 0x1a2b3c4d...?
   ↓
Commit 단계의 값과 일치!
   ↓
✅ 유효한 선택으로 인정
```

### 3단계: 집계 및 당첨자 결정

```
모든 선택 공개 완료
   ↓
블록별 선택 인원 집계:
블록 1번: 3명
블록 2번: 5명
블록 3번: 1명 ← 최소!
블록 4번: 4명
...
   ↓
최소 블록 선택자 중 가장 빨리 Commit한 사람 당첨
   ↓
블록체인 타임스탬프로 확인
```

## 보안 메커니즘

### 1. 선택 변경 불가

```
❌ 시도: Commit 후 선택 변경

불가능한 이유:
- Commit 값이 블록체인에 영구 기록됨
- 블록 번호를 바꾸면 Hash 값이 달라짐
- 원본 Commit 값과 일치하지 않음
→ 스마트 컨트랙트가 거부
```

**예시**
```
Commit 단계:
Hash(7번 + a7f3k2m9) = 0x1a2b3c4d...
→ 블록체인에 기록

Reveal 단계에서 변경 시도:
Hash(3번 + a7f3k2m9) = 0x9z8y7x6w...
→ 0x1a2b3c4d...와 불일치
→ ❌ 거부됨
```

### 2. 타인의 선택 엿보기 불가

```
❌ 시도: Commit 값으로 선택 추측

불가능한 이유:
- Hash 함수는 단방향 암호화
- 0x1a2b3c4d...만으로는 원본을 알 수 없음
- Nonce가 무작위이므로 추측 불가
```

**암호학적 강도**
```
SHA-256 해시 함수:
- 2^256 가지 경우의 수
- 현재 기술로 역계산 불가능
- 양자 컴퓨터로도 수십 년 소요
```

### 3. 사후 조작 불가

```
❌ 시도: 결과 발표 후 조작

불가능한 이유:
- 모든 과정이 블록체인에 기록
- 불변성 (Immutability)
- 누구나 검증 가능
```

## 실제 게임 예시

### 3명이 참여하는 3×3 게임

#### Commit 단계

```
시간 14:00:00 - 게임 시작

14:05:23 - 철수 Commit
  선택: 5번 (비공개)
  Hash: 0xabc123...

14:06:15 - 영희 Commit
  선택: 7번 (비공개)
  Hash: 0xdef456...

14:07:02 - 민수 Commit
  선택: 5번 (비공개)
  Hash: 0xghi789...

→ 모두 제출 완료, Reveal 대기
```

**블록체인 기록**
```
Transaction #1:
From: 철수
Commit: 0xabc123...
Timestamp: 2024-02-15 14:05:23
Block: #12345678

Transaction #2:
From: 영희
Commit: 0xdef456...
Timestamp: 2024-02-15 14:06:15
Block: #12345679

Transaction #3:
From: 민수
Commit: 0xghi789...
Timestamp: 2024-02-15 14:07:02
Block: #12345680
```

#### Reveal 단계

```
14:07:02 - 모든 참가자 Commit 완료
   ↓
14:12:02 - Reveal 카운트다운 종료 (5분 후)
   ↓
모든 선택 동시 공개:

철수: 5번 (14:05:23 Commit)
영희: 7번 (14:06:15 Commit)
민수: 5번 (14:07:02 Commit)
```

#### 집계 및 당첨

```
블록별 선택 인원:
블록 5번: 2명 (철수, 민수)
블록 7번: 1명 (영희) ← 최소!

당첨자: 영희
당첨 금액: 15,000원 (5,000원 × 3명)
```

### 만약 Commit-Reveal이 없었다면?

```
❌ 순차적 공개 방식:

14:05:23 - 철수: 5번 선택 → 즉시 공개
14:06:15 - 영희: (철수가 5번 선택한 것을 보고)
            → 7번 선택 → 공개
14:07:02 - 민수: (철수 5번, 영희 7번을 보고)
            → 1번 선택하여 유리하게!

결과: 나중에 선택한 민수가 압도적으로 유리
→ 불공정!
```

## 블록체인의 역할

### 1. 불변성 (Immutability)

```
Commit 값이 블록체인에 기록되면
→ 영구적으로 변경 불가
→ 누구도 조작할 수 없음
```

### 2. 투명성 (Transparency)

```
모든 참가자가 블록체인에서 확인 가능:
- Commit 시간
- Reveal 값
- 당첨자 결정 과정
```

### 3. 타임스탬프

```
블록체인 타임스탬프로 정확한 시간 기록
→ 동점자 발생 시 가장 빨리 Commit한 사람 당첨
→ 네트워크 지연 등 외부 요인 배제
```

### 4. 스마트 컨트랙트

```
자동 검증:
- Commit 값과 Reveal 값 일치 여부
- 타임스탬프 순서
- 당첨자 결정

사람의 개입 없이 자동 실행
→ 조작 불가능
```

## 검증 방법

### 일반 사용자

```
마이페이지 > 게임 이력 > 상세보기
   ↓
블록체인 검증 링크 클릭
   ↓
PolygonScan에서 확인:
- TX Hash
- Commit 값
- Reveal 값
- 타임스탬프
```

**PolygonScan 화면 예시**
```
┌──────────────────────────────┐
│ Transaction Details           │
├──────────────────────────────┤
│ TX Hash: 0x1a2b3c...         │
│ Block: 12345678              │
│ Timestamp: 2024-02-15 14:05  │
│ From: 0x9876...              │
│ To: BlockPick Contract       │
│ Function: commitChoice()     │
│ Input: 0xabc123...           │
└──────────────────────────────┘
```

### 기술 사용자

```
1. 스마트 컨트랙트 소스 코드 확인
   → PolygonScan에서 Verified Contract 조회

2. 함수 호출 기록 확인
   → commitChoice()
   → revealChoice()
   → determineWinner()

3. 이벤트 로그 확인
   → Commit 이벤트
   → Reveal 이벤트
   → Winner 이벤트
```

## 다른 방식과의 비교

### 일반 웹 게임

```
서버가 모든 선택 저장
→ 서버 관리자가 조작 가능
→ 사용자가 검증 불가
❌ 신뢰 필요
```

### Commit-Reveal + 블록체인

```
블록체인에 모든 과정 기록
→ 조작 불가능
→ 누구나 검증 가능
✅ 신뢰 불필요 (Zero Trust)
```

### 다른 복권 시스템

```
추첨 번호를 서버에서 생성
→ 난수 생성기 조작 가능성
→ 투명성 부족
❌ 신뢰 필요
```

### BlockPick

```
참여자들의 선택으로 당첨자 결정
→ 외부 난수 불필요
→ 완전 투명
✅ 검증 가능
```

## 기술적 세부사항

### 해시 함수

```javascript
// SHA-256 해시 함수 사용
function generateCommit(blockNumber, nonce) {
  const data = blockNumber.toString() + nonce;
  const hash = SHA256(data);
  return hash;
}

// 예시
generateCommit(7, "a7f3k2m9")
→ "0x1a2b3c4d5e6f7g8h..."
```

### 스마트 컨트랙트 (Solidity)

```solidity
// Commit 제출
function commitChoice(bytes32 _commitment) public {
  require(commits[msg.sender] == 0, "Already committed");
  commits[msg.sender] = _commitment;
  commitTime[msg.sender] = block.timestamp;
  emit Committed(msg.sender, _commitment);
}

// Reveal 제출
function revealChoice(uint8 _block, string memory _nonce) public {
  bytes32 commitment = keccak256(abi.encodePacked(_block, _nonce));
  require(commits[msg.sender] == commitment, "Invalid reveal");
  choices[msg.sender] = _block;
  emit Revealed(msg.sender, _block);
}

// 당첨자 결정
function determineWinner() public {
  // 최소 선택 블록 찾기
  uint8 minBlock = findMinBlock();

  // 해당 블록 선택자 중 가장 빨리 Commit한 사람
  address winner = findEarliestCommitter(minBlock);

  emit Winner(winner, minBlock);
}
```

## 자주 묻는 질문

### Q1. 정말 조작이 불가능한가요?
**A.** 네, 블록체인의 불변성과 Commit-Reveal 암호학 기법으로 조작이 원천적으로 불가능합니다. 모든 과정이 블록체인에 기록되어 누구나 검증할 수 있습니다.

### Q2. 다른 사람의 선택을 해킹할 수 있나요?
**A.** 불가능합니다. SHA-256 해시 함수는 현대 암호학에서 가장 안전한 단방향 함수 중 하나이며, Commit 값만으로는 원본 선택을 알아낼 수 없습니다.

### Q3. 관리자가 결과를 조작할 수 있나요?
**A.** 불가능합니다. 스마트 컨트랙트가 자동으로 실행되며, 사람의 개입 없이 당첨자가 결정됩니다. 관리자도 조작할 수 없습니다.

### Q4. 블록체인에 기록된다는 게 무슨 의미인가요?
**A.** Polygon 블록체인에 영구적으로 기록되어 누구도 수정하거나 삭제할 수 없다는 의미입니다. [PolygonScan](https://polygonscan.com)에서 직접 확인할 수 있습니다.

### Q5. Commit 후 선택을 바꾸면 안 되나요?
**A.** 불가능합니다. Commit 값이 블록체인에 기록되는 순간 변경이 불가능하며, Reveal 단계에서 다른 값을 제출하면 스마트 컨트랙트가 자동으로 거부합니다.

### Q6. 네트워크가 느려서 늦게 제출되면 불리한가요?
**A.** Commit 단계에서는 제출 순서가 타임스탬프로 기록되므로 네트워크 속도와 무관하게 공정합니다. Reveal 단계에서는 모든 선택이 동시에 공개되므로 네트워크 속도가 영향을 미치지 않습니다.

### Q7. 검증은 어떻게 하나요?
**A.** 마이페이지 > 게임 이력에서 "블록체인 검증" 버튼을 클릭하면 PolygonScan으로 연결되어 직접 확인할 수 있습니다.

### Q8. 양자 컴퓨터가 나오면 해킹 가능한가요?
**A.** 현재 SHA-256은 양자 컴퓨터에도 안전한 것으로 알려져 있습니다. 설령 미래에 위협이 된다면 양자 내성 해시 함수로 업그레이드할 수 있습니다.

## 공정성 보장

### BlockPick의 3가지 원칙

```
1. 투명성 (Transparency)
   모든 과정이 블록체인에 공개

2. 불변성 (Immutability)
   기록된 데이터는 영구적으로 변경 불가

3. 검증 가능성 (Verifiability)
   누구나 직접 검증 가능
```

### 신뢰할 필요 없는 시스템

```
기존 게임:
"우리는 공정합니다" → 믿어야 함

BlockPick:
"직접 검증하세요" → 믿을 필요 없음
```

## 더 알아보기

### 관련 기술

```
- SHA-256 해시 함수
- Polygon 블록체인
- 스마트 컨트랙트 (Solidity)
- 암호학적 타임스탬프
```

### 참고 자료

```
- Polygon Whitepaper
- Commit-Reveal Scheme (Wikipedia)
- SHA-256 Specification (NIST)
```

---

👉 [다음: 숙박 예약 가이드](./04-accommodation.md)

👉 [블록체인 검증하기](https://polygonscan.com)

## 문의하기

Commit-Reveal 방식에 대해 더 궁금한 점이 있으시면 연락주세요!

- 📧 이메일: tech@blockpick.io
- 💬 카카오톡: @blockpick
- ☎️ 고객센터: 1234-5678 (평일 09:00-18:00)
